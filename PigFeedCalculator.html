<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>çŒªåœºé¥²æ–™è®¢è´­é‡è®¡ç®—å™¨</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { 
      font-family: 'Microsoft YaHei', sans-serif; 
      padding: 2rem; 
      max-width: 1200px; 
      margin: 0 auto; 
      background-color: #f9f9f9; 
    }
    h1 { color: #333; text-align: center; }
    form { 
      background: white; 
      padding: 1.5rem; 
      border-radius: 8px; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
      margin-bottom: 1rem; 
    }
    label { 
      display: block; 
      margin-bottom: 1rem; 
      font-weight: bold; 
      color: #555; 
    }
    input { 
      width: 100%; 
      padding: 0.5rem; 
      border: 1px solid #ddd; 
      border-radius: 4px; 
      box-sizing: border-box; 
    }
    input:focus { border-color: #4CAF50; outline: none; }
    button { 
      margin-top: 1rem; 
      padding: 0.75rem 1.5rem; 
      background: #4CAF50; 
      color: white; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 1rem; 
    }
    button:hover { background: #45a049; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    #result { 
      overflow-x: auto; 
      background: white; 
      border-radius: 8px; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
      padding: 1rem; 
    }
    table { 
      border-collapse: collapse; 
      width: 100%; 
      margin-top: 1rem; 
      min-width: 800px;  
    }
    th, td { 
      border: 1px solid #ddd; 
      padding: 0.75rem; 
      text-align: right; 
    }
    th { 
      background: #f4f4f4; 
      font-weight: bold; 
      color: #333; 
    }
    tr:nth-child(even) { background: #f9f9f9; }
    tr:hover { background: #e8f5e8; }
    .total-row th, .total-row td { 
      font-weight: bold; 
      background: #e8f5e8 !important; 
      color: #2e7d32; 
    }
    .loading { text-align: center; color: #666; font-style: italic; }
    .export-btn { 
      background: #2196F3; 
      margin-left: 1rem; 
    }
    .export-btn:hover { background: #1976D2; }
    .copy-btn { 
      background: #FF9800; 
      margin-left: 1rem; 
    }
    .copy-btn:hover { background: #F57C00; }
    .image-btn { 
      background: #9C27B0; 
      margin-left: 1rem; 
    }
    .image-btn:hover { background: #7B1FA2; }
    .error { 
      color: #f44336; 
      background: #ffebee; 
      padding: 1rem; 
      border-radius: 4px; 
      margin: 1rem 0; 
    }
    .mobile-tip { 
      display: none; 
      text-align: center; 
      color: #666; 
      font-style: italic; 
      margin-bottom: 1rem; 
      padding: 0.5rem; 
      background: #e3f2fd; 
      border-radius: 4px; 
    }
    #tempCanvas { display: none; }  

    /* ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼šåª’ä½“æŸ¥è¯¢ */
    @media (max-width: 768px) {  
      body { padding: 1rem; }  
      input, button { font-size: 16px; padding: 0.75rem; }  
      table { font-size: 0.875rem; }  
      th, td { padding: 0.5rem; }  
      .mobile-tip { display: block; }
    }

    @media (max-width: 480px) {  
      h1 { font-size: 1.25rem; }
      .export-btn, .copy-btn, .image-btn { width: 100%; margin-top: 0.5rem; margin-left: 0; }  
      #result { padding: 0.5rem; }  
    }

    /* å¢å¼ºæ»šåŠ¨æ¡ï¼ˆWebKitæµè§ˆå™¨ï¼‰ */
    #result::-webkit-scrollbar { height: 8px; }
    #result::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>çŒªåœºæœˆåº¦é¥²æ–™è®¢è´­é‡è®¡ç®—å™¨</h1>
  <form id="feedForm">
    <label for="startDate">è¿›çŒªæ—¥æœŸ: 
      <input type="date" id="startDate" required>
    </label>
    <label for="pigCount">è¿›çŒªæ•°é‡ (å¤´): 
      <input type="number" id="pigCount" min="1" step="1" required>
    </label>
    <button type="submit">è®¡ç®—</button>
    <button type="button" id="resetBtn" style="display:none; background: #ff9800;">é‡ç½®</button>
  </form>
  <div id="result"></div>
  <canvas id="tempCanvas"></canvas>  

  <script>
    // é…ç½®å¸¸é‡
    const CONFIG = {
      stages: [
        { id: 110, qty: 6 },
        { id: 120, qty: 15 },
        { id: 121, qty: 17.5 },
        { id: 122, qty: 30 },
        { id: 130, qty: 60 },
        { id: 140, qty: 60 },
        { id: 141, qty: 102 }
      ],
      dailyIntake: [
        0.35,0.36,0.37,0.38,0.39,0.40,0.41,0.42,0.43,0.44,0.45,0.46,0.47,0.48,0.49,0.50,0.51,0.52,0.53,0.54,0.55,0.56,0.57,0.58,0.59,0.60,0.61,0.62,0.63,0.64,0.65,0.66,0.67,0.68,0.69,0.70,0.71,1.30,1.34,1.38,1.41,1.45,1.48,1.50,1.52,1.54,1.56,1.58,1.60,1.62,1.64,1.66,1.68,1.70,1.72,1.73,1.75,1.77,1.79,1.81,1.83,1.85,1.89,1.93,1.96,1.99,2.02,2.05,2.08,2.11,2.13,2.16,2.19,2.22,2.25,2.28,2.30,2.32,2.34,2.36,2.38,2.40,2.42,2.44,2.45,2.47,2.49,2.52,2.52,2.54,2.56,2.58,2.60,2.62,2.64,2.66,2.68,2.70,2.72,2.74,2.76,2.78,2.80,2.81,2.83,2.85,2.87,2.89,2.91,2.93,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00,3.00
      ],
      totalDays: 165
    };

    // å…¨å±€å˜é‡å­˜å‚¨monthlyæ•°æ®ï¼Œç”¨äºå¯¼å‡º
    let currentMonthlyData = null;
    let currentTableData = [];  

    // äº‹ä»¶ç›‘å¬
    const form = document.getElementById('feedForm');
    const resetBtn = document.getElementById('resetBtn');
    const resultDiv = document.getElementById('result');

    form.addEventListener('submit', handleSubmit);
    resetBtn.addEventListener('click', resetForm);

    function handleSubmit(e) {
      e.preventDefault();
      const startInput = document.getElementById('startDate').value;
      const pigCount = parseInt(document.getElementById('pigCount').value, 10);
      const now = new Date();
      now.setHours(0, 0, 0, 0);
      const startDate = new Date(startInput);

      // è¾“å…¥éªŒè¯
      if (!startInput || isNaN(pigCount) || pigCount <= 0) {
        showError('è¯·è¾“å…¥æœ‰æ•ˆçš„è¿›çŒªæ—¥æœŸå’Œæ•°é‡ï¼ˆæ•°é‡å¿…é¡»å¤§äº0å¤´ï¼‰ã€‚');
        return;
      }
      if (startDate >= now) {
        showError('è¿›çŒªæ—¥æœŸä¸èƒ½æ™šäºæˆ–ç­‰äºå½“å‰æ—¥æœŸï¼Œè¯·é€‰æ‹©è¿‡å»æ—¥æœŸã€‚');
        return;
      }

      // æ˜¾ç¤ºåŠ è½½
      resultDiv.innerHTML = '<div class="loading">è®¡ç®—ä¸­ï¼Œè¯·ç¨å€™...</div>';
      form.querySelector('button[type="submit"]').disabled = true;

      // å¼‚æ­¥è®¡ç®—
      setTimeout(() => {
        calculateFeed(startDate, pigCount);
        form.querySelector('button[type="submit"]').disabled = false;
        resetBtn.style.display = 'inline-block';
      }, 100);
    }

    function calculateFeed(startDate, count) {
      const monthly = {};
      let stageIndex = 0;
      let stageConsumed = 0;

      for (let i = 0; i < CONFIG.totalDays; i++) {
        const intake = CONFIG.dailyIntake[i] * count;
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i + 1);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

        if (!monthly[monthKey]) monthly[monthKey] = {};

        let remainIntake = intake;
        while (remainIntake > 0 && stageIndex < CONFIG.stages.length) {
          const stage = CONFIG.stages[stageIndex];
          const stageTotal = stage.qty * count;
          const remainStage = stageTotal - stageConsumed;
          const used = Math.min(remainIntake, remainStage);
          monthly[monthKey][stage.id] = (monthly[monthKey][stage.id] || 0) + used;
          remainIntake -= used;
          stageConsumed += used;
          if (stageConsumed >= stageTotal) {
            stageIndex++;
            stageConsumed = 0;
          }
        }
        if (stageIndex >= CONFIG.stages.length) break;
      }

      currentMonthlyData = monthly;
      renderTable(monthly);
    }

    function renderTable(monthly) {
      currentTableData = [['æœˆä»½', ...CONFIG.stages.map(s => s.id), 'åˆè®¡ (å¨)']];  

      let html = '<div class="mobile-tip">ğŸ’¡ å°å±æç¤ºï¼šåœ¨è¡¨æ ¼ä¸Šå·¦å³æ»‘åŠ¨æŸ¥çœ‹å®Œæ•´æ•°æ®</div><table><thead><tr><th>æœˆä»½</th>';
      CONFIG.stages.forEach(stage => {
        html += `<th data-label="${stage.id}">${stage.id}</th>`;
      });
      html += '<th data-label="åˆè®¡">åˆè®¡ (å¨)</th></tr></thead><tbody>';

      let totalSum = 0;
      const sortedMonths = Object.keys(monthly).sort();
      sortedMonths.forEach(monthKey => {
        let monthSum = 0;
        let row = `<tr><td data-label="æœˆä»½">${monthKey}</td>`;
        let dataRow = [monthKey];  
        CONFIG.stages.forEach(stage => {
          const kg = monthly[monthKey][stage.id] || 0;
          const tons = Math.round((kg / 1000) * 100) / 100;
          monthSum += kg;
          row += `<td data-label="${stage.id}">${tons.toFixed(2)}</td>`;
          dataRow.push(tons.toFixed(2));
        });
        const monthTons = Math.round((monthSum / 1000) * 100) / 100;
        row += `<td data-label="åˆè®¡">${monthTons.toFixed(2)}</td></tr>`;
        html += row;
        dataRow.push(monthTons.toFixed(2));
        currentTableData.push(dataRow);
        totalSum += monthSum;
      });

      // æ€»è®¡è¡Œ
      let totalRow = '<tr class="total-row"><td data-label="æœˆä»½"><strong>æ€»è®¡</strong></td>';
      let totalDataRow = ['æ€»è®¡'];
      CONFIG.stages.forEach(stage => {
        const totalKg = sortedMonths.reduce((acc, m) => acc + (monthly[m][stage.id] || 0), 0);
        const totalTons = Math.round((totalKg / 1000) * 100) / 100;
        totalRow += `<td data-label="${stage.id}"><strong>${totalTons.toFixed(2)}</strong></td>`;
        totalDataRow.push(totalTons.toFixed(2));
      });
      const grandTotal = Math.round((totalSum / 1000) * 100) / 100;
      totalRow += `<td data-label="åˆè®¡"><strong>${grandTotal.toFixed(2)}</strong></td></tr>`;
      html += totalRow + '</tbody></table>';

      // æ·»åŠ æŒ‰é’®
      html += `<button class="export-btn" onclick="exportXLSX()">å¯¼å‡ºExcel</button>`;
      html += `<button class="copy-btn" onclick="copyToClipboard()">å¤åˆ¶è¡¨æ ¼</button>`;
      html += `<button class="image-btn" onclick="copyAsImage()">å¤åˆ¶ä¸ºå›¾ç‰‡</button>`;

      resultDiv.innerHTML = html;
    }

    function exportXLSX() {
      if (!currentTableData || currentTableData.length === 0) {
        alert('æ— æ•°æ®å¯å¯¼å‡ºï¼Œè¯·å…ˆè®¡ç®—ã€‚');
        return;
      }
      try {
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(currentTableData);
        XLSX.utils.book_append_sheet(wb, ws, 'é¥²æ–™è®¢è´­é‡');
        
        // ä½¿ç”¨FileSaver.jsç¡®ä¿è·¨æµè§ˆå™¨å…¼å®¹ï¼ŒåŒ…æ‹¬ç§»åŠ¨ç«¯
        XLSX.writeFile(wb, `é¥²æ–™è®¢è´­_${new Date().toISOString().slice(0,10)}.xlsx`);
        alert('Excelæ–‡ä»¶å·²ä¸‹è½½ï¼è¯·æ£€æŸ¥ä¸‹è½½æ–‡ä»¶å¤¹æˆ–â€œæ–‡ä»¶â€Appã€‚');
      } catch (err) {
        console.error('Export error:', err);
        alert('å¯¼å‡ºå¤±è´¥ï¼š' + err.message + 'ã€‚è¯·å°è¯•å¤åˆ¶è¡¨æ ¼ã€‚');
      }
    }

    function copyToClipboard() {
      if (currentTableData.length === 0) {
        alert('æ— æ•°æ®å¯å¤åˆ¶ï¼Œè¯·å…ˆè®¡ç®—ã€‚');
        return;
      }
      const tsv = currentTableData.map(row => row.join('\t')).join('\n');
      navigator.clipboard.writeText(tsv).then(() => {
        alert('è¡¨æ ¼å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼å¯ç²˜è´´åˆ°Excelæˆ–Google Sheetsä¸­ã€‚');
      }).catch(() => {
        const textarea = document.createElement('textarea');
        textarea.value = tsv;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        alert('è¡¨æ ¼å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼å¯ç²˜è´´åˆ°Excelæˆ–Google Sheetsä¸­ã€‚');
      });
    }

    async function copyAsImage() {
      const table = resultDiv.querySelector('table');
      if (!table) {
        alert('æ— è¡¨æ ¼æ•°æ®ï¼Œè¯·å…ˆè®¡ç®—ã€‚');
        return;
      }

      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      if (isMobile) {
        alert('ç§»åŠ¨è®¾å¤‡ï¼šæ­£åœ¨ç”Ÿæˆå›¾ç‰‡ï¼ˆéœ€å‡ ç§’ï¼‰...');
      }

      const timeout = setTimeout(() => {
        alert('ç”Ÿæˆè¶…æ—¶ï¼Œè¯·å°è¯•å…¶ä»–æ–¹å¼ã€‚');
      }, 15000);

      try {
        window.scrollTo(0, 0);
        const scale = isMobile ? 0.8 : 2;
        const canvas = await html2canvas(table, {
          scale: scale,
          useCORS: false,
          allowTaint: true,
          backgroundColor: '#ffffff',
          logging: false,
          width: table.scrollWidth,
          height: table.scrollHeight,
          windowWidth: table.scrollWidth
        });
        clearTimeout(timeout);

        canvas.toBlob((blob) => {
          saveAs(blob, `é¥²æ–™è®¢è´­_${new Date().toISOString().slice(0,10)}.png`);
          if (isMobile) {
            alert('å›¾ç‰‡å·²ä¸‹è½½åˆ°æ‚¨çš„è®¾å¤‡ï¼');
          } else {
            alert('å›¾ç‰‡å·²ä¸‹è½½ã€‚');
          }
        }, 'image/png');
      } catch (err) {
        clearTimeout(timeout);
        alert('ç”Ÿæˆå¤±è´¥ï¼š' + err.message + 'ã€‚è¯·å°è¯•å¯¼å‡ºExcelã€‚');
      }
    }

    function showError(message) {
      resultDiv.innerHTML = `<div class="error">${message}</div>`;
    }

    function resetForm() {
      form.reset();
      resultDiv.innerHTML = '';
      resetBtn.style.display = 'none';
      form.querySelector('button[type="submit"]').disabled = false;
      currentMonthlyData = null;
      currentTableData = [];
    }
  </script>
</body>
</html>